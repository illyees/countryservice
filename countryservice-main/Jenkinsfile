pipeline {
    agent any
    
    tools {
        maven 'mymaven'
        jdk 'JDK21'
    }
    
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/illyees/countryservice.git'
            }
        }
        
        stage('Diagnose Structure') {
            steps {
                sh '''
                    echo "=== STRUCTURE DU DEPOT ==="
                    pwd
                    ls -la
                    echo "=== CONTENU ==="
                    find . -name "pom.xml" -type f
                    echo "=== LISTE COMPLETE ==="
                    find . -type f -name "*.java" | head -10
                    find . -type f -name "*.xml" | head -10
                '''
            }
        }
        
        stage('Build & Test') {
            steps {
                sh '''
                    echo "=== TENTATIVE DE BUILD ==="
                    # Essayer de trouver et construire depuis le bon dossier
                    if [ -f "pom.xml" ]; then
                        echo "Building from root directory"
                        mvn clean compile
                    else
                        echo "No pom.xml in root, searching..."
                        find . -name "pom.xml" -exec dirname {} \\; | head -1 | xargs -I {} sh -c 'cd {} && mvn clean compile'
                    fi
                '''
            }
        }
    }
    
    post {
        always {
            echo "Build ${currentBuild.currentResult} - ${env.JOB_NAME} #${env.BUILD_NUMBER}"
        }
    }
}
